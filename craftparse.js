let initialMaterials={};function generateMaterialList(){const e=document.querySelector("#yourMaterials .materials-list");e.innerHTML="",Object.entries(materials).forEach((([t,n])=>{const a=document.createElement("div");a.className=`my-material ${t.toLowerCase().replace(/\s/g,"-")}`;const l=document.createElement("img");l.src=n.img,a.appendChild(l);const c=document.createElement("div"),r=document.createElement("span");r.textContent=t,c.appendChild(r);const o=formatPlaceholderWithCommas(`${Math.floor(4*Math.random())+3}${Array.from({length:6},(()=>Math.floor(10*Math.random()))).join("")}`),s=document.createElement("input");s.type="text",s.className="numeric-input",s.id=`my-${t.toLowerCase().replace(/\s/g,"-")}`,s.name=`my-${t.toLowerCase().replace(/\s/g,"-")}`,s.placeholder=o,c.appendChild(s),a.appendChild(c),e.appendChild(a)}))}function formatPlaceholderWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function formatedInputNumber(){document.addEventListener("input",(function(e){if(e.target.classList.contains("numeric-input")){let t=e.target.value.replace(/[^0-9,]/g,"").replace(/,/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,",");e.target.value=t}}))}function setTemplateValues(e){document.querySelectorAll('#manualInput input[type="number"]').forEach((e=>{e.value=""})),Object.entries(e).forEach((([e,t])=>{Object.entries(t).forEach((([e,t])=>{const n=document.querySelector(`input[name="${e}"]`);n&&(n.value=t)}))}))}function addCalculateButton(){const e=document.getElementById("manualInput"),t=document.getElementById("generatebychoice"),n=document.createElement("button");n.textContent="Calculate",n.classList.add("calculate-button"),n.addEventListener("click",calculateMaterials),e.appendChild(n);const a=document.createElement("div");a.classList.add("generate-480"),a.textContent="Generate 480",a.addEventListener("click",(function(){setTemplateValues({1:{"Flax Legwraps":214,"Copper Band":232,Dagger:34},5:{"Boiled Leather Shirt":175,"Wool Bandana":152,Spear:153},10:{"Copper Pot":70,"Padded Armor":61,"Wool Leggings":59,Galoshes:75,"Velvet Boots":11,Mace:70,"Short Bow":75,"Pyrite Lament":59}}),calculateMaterials(),addMultiplierButtons()})),t.appendChild(a)}function addMultiplierButtons(){const e=document.getElementById("results");let t=e.querySelector(".generate");if(t)t.innerHTML="";else{t=document.createElement("div"),t.className="generate";const n=e.querySelector(".materials");n.nextSibling?e.insertBefore(t,n.nextSibling):e.appendChild(t)}[2,3,4].forEach((e=>{const n=document.createElement("button");n.textContent=`x${e}`,n.className="multiplier-btn",n.addEventListener("click",(()=>multiplyValues(e))),t.appendChild(n)}))}function multiplyValues(e){document.getElementById("results").innerHTML="",document.querySelectorAll('#manualInput input[type="number"]').forEach((t=>{t.value&&(t.value=parseInt(t.value)*e)})),calculateMaterials(),addMultiplierButtons()}function showResults(){document.getElementById("results").style.display="block",document.getElementById("generatebychoice").style.display="none",window.scrollTo({top:0,behavior:"smooth"})}function closeResults(){document.getElementById("results").innerHTML="",document.getElementById("results").style.display="none",document.getElementById("generatebychoice").style.display="block"}function createCloseButton(e){const t=document.createElement("button");t.id="closeResults",t.onclick=closeResults,t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M345 137c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-119 119L73 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l119 119L39 375c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l119-119L311 409c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-119-119L345 137z"/></svg>',e.appendChild(t)}function createLevelStructure(){const e=document.getElementById("manualInput");[1,5,10].forEach((t=>{const n=document.createElement("h3");n.textContent=`Level ${t}`,n.style.cursor="pointer",e.appendChild(n);const a=document.createElement("div");a.id=`level-${t}-items`,a.style.display=1===t?"block":"none",e.appendChild(a),n.addEventListener("click",(()=>{a.style.display="none"===a.style.display?"block":"none"})),craftItem.products.filter((e=>e.level===t)).forEach((e=>{const t=document.createElement("div"),n=document.createElement("label");n.textContent=e.name;const l=document.createElement("input");l.type="number",l.name=e.name,l.placeholder="amount",t.appendChild(n),t.appendChild(l),a.appendChild(t)}))}))}function calculateMaterials(){const e=document.getElementById("results"),t=document.createElement("div");t.className="materials",e.appendChild(t);const n={1:[],5:[],10:[]},a={};document.querySelectorAll('div[id^="level-"]').forEach((e=>{const t=parseInt(e.id.split("-")[1]);e.querySelectorAll('input[type="number"]').forEach((e=>{const l=parseInt(e.value)||0,c=e.name,r=craftItem.products.find((e=>e.name===c));r&&l>0&&(n[t].push({name:c,amount:l,img:r.img}),Object.entries(r.materials).forEach((([e,t])=>{a[e]||(a[e]={amount:0,img:materials[e].img}),a[e].amount+=t*l})))}))})),Object.entries(a).forEach((([e,n])=>{const a=document.createElement("div"),l=document.createElement("img");l.src=n.img,l.alt=e,a.appendChild(l);const c=document.createElement("p"),r=document.createElement("p"),o=document.createElement("p");c.className="name",r.className="amount",o.className="available-materials",c.textContent=`${e}`,r.textContent=`-${new Intl.NumberFormat("en-US").format(n.amount)}`;const s=e.toLowerCase().replace(/\s+/g,"-"),i=initialMaterials[s]||0;if(i>0){const e=i-n.amount;e>=0&&(o.textContent=`${new Intl.NumberFormat("en-US").format(e)}`)}a.appendChild(c),a.appendChild(r),a.appendChild(o),t.appendChild(a)}));const l=document.createElement("div");l.className="generate",t.after(l);const c=calculateTotalItemsByLevel(n),r=areAllCountsSame(c);if(r&&c[1]>0){const e=document.createElement("h2");e.textContent=`Total templates: ${new Intl.NumberFormat("en-US").format(c[1])} pcs`,t.after(e),e.after(l)}else t.after(l);const o=document.createElement("div");o.className="items",l.after(o),Object.entries(n).forEach((([e,t])=>{if(t.length>0){const n=document.createElement("h4");n.textContent=r?`Level ${e}`:`Level ${e} (${new Intl.NumberFormat("en-US").format(c[e])} pcs)`,o.appendChild(n);const a=document.createElement("div");a.className="level-group",o.appendChild(a),t.forEach((e=>{const t=document.createElement("div"),n=document.createElement("img");n.src=e.img,n.alt=e.name,t.appendChild(n);const l=document.createElement("p"),c=document.createElement("p");l.className="name",c.className="amount",l.textContent=`${e.name}`,c.textContent=`${new Intl.NumberFormat("en-US").format(e.amount)}`,t.appendChild(l),t.appendChild(c),a.appendChild(t)}))}})),createCloseButton(e),showResults()}function calculateTotalItemsByLevel(e){let t={};return Object.keys(e).forEach((n=>{const a=e[n].reduce(((e,t)=>e+t.amount),0);t[n]=a})),t}function areAllCountsSame(e){const t=Object.values(e);return t.every((e=>e===t[0]))}function createMaterialImageElement(e,t,n){const a=document.createElement("img");return a.src=t,a.alt=e,a.className="material-image",a.dataset.materialName=e,a.dataset.preference=n,a.addEventListener("click",(function(){this.classList.toggle("selected")})),a}function gatherMaterialsFromInputs(){let e={};return document.querySelectorAll('.my-material input[type="text"]').forEach((t=>{const n=t.getAttribute("name").replace("my-",""),a=parseInt(t.value.replace(/,/g,""),10);isNaN(a)||(e[n]=a)})),e}function calculateProductionPlan(e,t){let n={1:[],5:[],10:[]};for(let a=0;a<t;a++){let t=getUserPreferences(e),l={1:null,5:null,10:null};for(let c of[1,5,10]){const r=selectProductForLevel(craftItem.products.filter((e=>e.level===c)),t.mostAvailableMaterials,t.secondMostAvailableMaterials,t.leastAvailableMaterials,e);if(!r)return c>1&&(n[1].pop(),c>5&&n[5].pop(),displayUserMessage(`The given materials ran out. <br>Only ${a} templates could be produced.`)),n;n[c].push(r.name),l[c]=r,updateAvailableMaterials(e,r)}}return n}function displayUserMessage(e){const t=document.getElementById("results"),n=document.createElement("h3");n.innerHTML=e;const a=t.querySelector(".generate");t.insertBefore(n,a)}function updateAvailableMaterials(e,t){Object.entries(t.materials).forEach((([t,n])=>{const a=t.toLowerCase().replace(/ /g,"-");void 0!==e[a]&&(e[a]-=n)}))}function getUserPreferences(e){let t=Object.entries(e).sort(((e,t)=>t[1]-e[1])),n=[...new Set(t.map((([e,t])=>t)))],a=[],l=[],c=[],r=n[0];if(a=t.filter((([e,t])=>t===r)).map((([e,t])=>e)),a.length<4){let e=1;for(;l.length<4-a.length&&e<n.length;){let a=n[e],c=t.filter((([e,t])=>t===a)).map((([e,t])=>e));l.push(...c),e++}l=l.slice(0,4-a.length)}if(a.length+l.length<12){let e=4;a.length+l.length>8&&(e=12-(a.length+l.length));for(let a=n.length-e;a<n.length;a++){let e=n[a];c.push(...t.filter((([t,n])=>n===e)).map((([e,t])=>e)))}c=c.slice(0,e)}return{mostAvailableMaterials:a,secondMostAvailableMaterials:l,leastAvailableMaterials:c}}function selectProductForLevel(e,t,n,a,l){let c=null,r=-1/0;return e.forEach((e=>{let o=getMaterialScore(e,t,n,a);canProductBeProduced(e,l)&&o>r&&(c=e,r=o,Object.entries(e.materials).forEach((([e,t])=>{void 0!==l[e]&&(l[e]-=t)})))})),c}function getMaterialScore(e,t,n,a){let l=0;return Object.entries(e.materials).forEach((([e,c])=>{let r=e.toLowerCase().replace(/ /g,"-");t.includes(r)&&(l+=10),n.includes(r)&&(l+=5),a.includes(r)&&(l-=10)})),l}function canProductBeProduced(e,t){return Object.entries(e.materials).every((([e,n])=>{const a=e.toLowerCase().replace(/ /g,"-");return t[a]&&t[a]>=n}))}function listSelectedProducts(e){Object.entries(e).forEach((([e,t])=>{t.forEach((t=>{const n=document.querySelector(`#level-${e}-items input[name="${t}"]`);n&&(n.value=(parseInt(n.value)||0)+1)}))}))}function inputActive(){document.querySelector(".material-choices").addEventListener("click",(e=>{document.querySelectorAll(".material-choices .my-material").forEach((e=>{""===e.querySelector(".numeric-input").value&&e.classList.remove("active")}));const t=e.target.closest(".my-material");t&&(t.classList.add("active"),t.querySelector(".numeric-input").focus())})),document.querySelectorAll(".material-choices .my-material .numeric-input").forEach((e=>{e.addEventListener("focusout",(()=>{""===e.value&&e.closest(".my-material").classList.remove("active")})),e.addEventListener("focus",(()=>{document.querySelectorAll(".material-choices .my-material").forEach((e=>{""===e.querySelector(".numeric-input").value&&e.classList.remove("active")})),e.closest(".my-material").classList.add("active")}))}));const e=document.querySelector("#templateAmount"),t=document.querySelector(".templateAmountWrap");e.addEventListener("focus",(()=>{t.classList.add("active")})),e.addEventListener("blur",(()=>{e.value||t.classList.remove("active")}))}document.addEventListener("DOMContentLoaded",(function(){createLevelStructure(),addCalculateButton(),generateMaterialList(),formatedInputNumber(),inputActive()})),document.getElementById("calculateWithPreferences").addEventListener("click",(function(){const e=[...document.querySelectorAll('.my-material input[type="text"]'),...document.querySelectorAll("#templateAmount")];let t=!0;if(e.forEach((e=>{e.value&&0!==parseInt(e.value.replace(/,/g,""))||(t=!1,e.classList.add("missing-input"),setTimeout((()=>{e.classList.remove("missing-input")}),3e3))})),!t)return;let n=gatherMaterialsFromInputs();0===Object.keys(initialMaterials).length&&(initialMaterials={...n});let a=parseInt(document.getElementById("templateAmount").value.replace(/,/g,""));if(isNaN(a))return;let l=calculateProductionPlan(n,a);document.querySelectorAll('#manualInput input[type="number"]').forEach((e=>{e.value=""})),listSelectedProducts(l);const c=document.querySelector(".calculate-button");c&&c.click()}));
