let initialMaterials={};const urlParams=new URLSearchParams(window.location.search),isDebugMode=urlParams.has("debug")&&"true"===urlParams.get("debug");function generateMaterialList(){const e=document.querySelector("#yourMaterials .materials-list");e.innerHTML="",Object.entries(materials).forEach((([t,a])=>{const n=document.createElement("div");n.className=`my-material ${t.toLowerCase().replace(/\s/g,"-")}`;const l=document.createElement("img");l.src=a.img,n.appendChild(l);const c=document.createElement("div"),r=document.createElement("span");r.textContent=t,c.appendChild(r);const o=document.createElement("input");o.type="text",o.className="numeric-input",o.id=`my-${t.toLowerCase().replace(/\s/g,"-")}`,o.name=`my-${t.toLowerCase().replace(/\s/g,"-")}`,o.placeholder="value",o.pattern="[0-9]*",o.inputMode="numeric",c.appendChild(o),n.appendChild(c),e.appendChild(n)}))}function formatPlaceholderWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function formatedInputNumber(){document.addEventListener("input",(function(e){if(e.target.classList.contains("numeric-input")){let t=e.target.value.replace(/[^0-9,]/g,"").replace(/,/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,",");e.target.value=t}}))}function setTemplateValues(e){document.querySelectorAll('#manualInput input[type="number"]').forEach((e=>{e.value=""})),Object.entries(e).forEach((([e,t])=>{Object.entries(t).forEach((([e,t])=>{const a=document.querySelector(`input[name="${e}"]`);a&&(a.value=t)}))}))}function addCalculateButton(){const e=document.getElementById("manualInput"),t=document.getElementById("generatebychoice"),a=document.createElement("button");a.textContent="Calculate",a.classList.add("calculate-button"),a.addEventListener("click",calculateMaterials),e.appendChild(a);const n=document.createElement("div");n.classList.add("generate-480"),n.textContent="Generate 480",n.addEventListener("click",(function(){setTemplateValues({1:{"Flax Legwraps":214,"Copper Band":232,Dagger:34},5:{"Boiled Leather Shirt":175,"Wool Bandana":152,Spear:153},10:{"Copper Pot":70,"Padded Armor":61,"Wool Leggings":59,Galoshes:75,"Velvet Boots":11,Mace:70,"Short Bow":75,"Pyrite Lament":59}}),calculateMaterials(),addMultiplierButtons(),isDebugMode||gtag("event","generate-480",{value:1})})),t.appendChild(n)}function addMultiplierButtons(){const e=document.getElementById("results");let t=e.querySelector(".generate");if(t)t.innerHTML="";else{t=document.createElement("div"),t.className="generate";const a=e.querySelector(".materials");a.nextSibling?e.insertBefore(t,a.nextSibling):e.appendChild(t)}[2,3,4].forEach((e=>{const a=document.createElement("button");a.textContent=`x${e}`,a.className="multiplier-btn",a.addEventListener("click",(()=>multiplyValues(e))),t.appendChild(a)}))}function multiplyValues(e){document.getElementById("results").innerHTML="",document.querySelectorAll('#manualInput input[type="number"]').forEach((t=>{t.value&&(t.value=parseInt(t.value)*e)})),isDebugMode||gtag("event","generate-480-multiplier",{event_multiplier_value:e,value:1}),calculateMaterials(),addMultiplierButtons()}function showResults(){document.getElementById("results").style.display="block",document.getElementById("generatebychoice").style.display="none",window.scrollTo({top:0,behavior:"smooth"}),document.querySelector(".spinner-wrap").classList.remove("active")}function closeResults(){document.getElementById("results").innerHTML="",document.getElementById("results").style.display="none",document.getElementById("generatebychoice").style.display="block"}function createCloseButton(e){const t=document.createElement("button");t.id="closeResults",t.onclick=closeResults,t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M345 137c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-119 119L73 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l119 119L39 375c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l119-119L311 409c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-119-119L345 137z"/></svg>',e.appendChild(t)}function createLevelStructure(){const e=document.getElementById("manualInput");[1,5,10].forEach((t=>{const a=document.createElement("h3");a.textContent=`Level ${t}`,a.style.cursor="pointer",e.appendChild(a);const n=document.createElement("div");n.id=`level-${t}-items`,n.style.display=1===t?"block":"none",e.appendChild(n),a.addEventListener("click",(()=>{n.style.display="none"===n.style.display?"block":"none"})),craftItem.products.filter((e=>e.level===t)).forEach((e=>{const t=document.createElement("div"),a=document.createElement("label");a.textContent=e.name;const l=document.createElement("input");l.type="number",l.name=e.name,l.placeholder="amount",t.appendChild(a),t.appendChild(l),n.appendChild(t)}))}))}function calculateMaterials(){const e=document.getElementById("results"),t=document.createElement("div");t.className="materials",e.appendChild(t);const a={1:[],5:[],10:[]},n={};document.querySelectorAll('div[id^="level-"]').forEach((e=>{const t=parseInt(e.id.split("-")[1]);e.querySelectorAll('input[type="number"]').forEach((e=>{const l=parseInt(e.value)||0,c=e.name,r=craftItem.products.find((e=>e.name===c));r&&l>0&&(a[t].push({name:c,amount:l,img:r.img}),Object.entries(r.materials).forEach((([e,t])=>{n[e]||(n[e]={amount:0,img:materials[e].img}),n[e].amount+=t*l})))}))})),Object.entries(n).forEach((([e,a])=>{const n=document.createElement("div"),l=document.createElement("img");l.src=a.img,l.alt=e,n.appendChild(l);const c=document.createElement("p"),r=document.createElement("p"),o=document.createElement("p");c.className="name",r.className="amount",o.className="available-materials",c.textContent=`${e}`,r.textContent=`-${new Intl.NumberFormat("en-US").format(a.amount)}`;const s=e.toLowerCase().replace(/\s+/g,"-"),i=initialMaterials[s]||0;if(i>0){const e=i-a.amount;e>=0&&(o.textContent=`${new Intl.NumberFormat("en-US").format(e)}`)}n.appendChild(c),n.appendChild(r),n.appendChild(o),t.appendChild(n)}));const l=document.createElement("div");l.className="generate",t.after(l);const c=calculateTotalItemsByLevel(a),r=areAllCountsSame(c);if(r&&c[1]>0){const e=document.createElement("h2");e.textContent=`Total templates: ${new Intl.NumberFormat("en-US").format(c[1])} pcs`,isDebugMode||gtag("event","total templates",{event_templates:c,value:1}),t.after(e),e.after(l)}else t.after(l);const o=document.createElement("div");o.className="items",l.after(o),Object.entries(a).forEach((([e,t])=>{if(t.length>0){const a=document.createElement("h4");a.textContent=r?`Level ${e}`:`Level ${e} (${new Intl.NumberFormat("en-US").format(c[e])} pcs)`,o.appendChild(a);const n=document.createElement("div");n.className="level-group",o.appendChild(n),t.forEach((e=>{const t=document.createElement("div"),a=document.createElement("img");a.src=e.img,a.alt=e.name,t.appendChild(a);const l=document.createElement("p"),c=document.createElement("p");l.className="name",c.className="amount",l.textContent=`${e.name}`,c.textContent=`${new Intl.NumberFormat("en-US").format(e.amount)}`,t.appendChild(l),t.appendChild(c),n.appendChild(t)}))}})),createCloseButton(e),showResults()}function calculateTotalItemsByLevel(e){let t={};return Object.keys(e).forEach((a=>{const n=e[a].reduce(((e,t)=>e+t.amount),0);t[a]=n})),t}function areAllCountsSame(e){const t=Object.values(e);return t.every((e=>e===t[0]))}function createMaterialImageElement(e,t,a){const n=document.createElement("img");return n.src=t,n.alt=e,n.className="material-image",n.dataset.materialName=e,n.dataset.preference=a,n.addEventListener("click",(function(){this.classList.toggle("selected")})),n}function gatherMaterialsFromInputs(){let e={};return document.querySelectorAll('.my-material input[type="text"]').forEach((t=>{const a=t.getAttribute("name").replace("my-",""),n=parseInt(t.value.replace(/,/g,""),10);isNaN(n)||(e[a]=n)})),e}function calculateProductionPlan(e,t){let a={1:[],5:[],10:[]};for(let n=0;n<t;n++){let t=getUserPreferences(e),l={1:null,5:null,10:null};for(let c of[1,5,10]){const r=selectProductForLevel(craftItem.products.filter((e=>e.level===c)),t.mostAvailableMaterials,t.secondMostAvailableMaterials,t.leastAvailableMaterials,e);if(!r)return c>1&&(a[1].pop(),c>5&&a[5].pop(),displayUserMessage(`The given materials ran out. <br>Only ${n} templates could be produced.`)),a;a[c].push(r.name),l[c]=r,updateAvailableMaterials(e,r)}}return a}function displayUserMessage(e){const t=document.getElementById("results"),a=document.createElement("h3");a.innerHTML=e;const n=t.querySelector(".generate");t.insertBefore(a,n)}function updateAvailableMaterials(e,t){Object.entries(t.materials).forEach((([t,a])=>{const n=t.toLowerCase().replace(/ /g,"-");void 0!==e[n]&&(e[n]-=a)}))}function getUserPreferences(e){let t=Object.entries(e).sort(((e,t)=>t[1]-e[1])),a=[...new Set(t.map((([e,t])=>t)))],n=[],l=[],c=[],r=a[0];if(n=t.filter((([e,t])=>t===r)).map((([e,t])=>e)),n.length<4){let e=1;for(;l.length<4-n.length&&e<a.length;){let n=a[e],c=t.filter((([e,t])=>t===n)).map((([e,t])=>e));l.push(...c),e++}l=l.slice(0,4-n.length)}if(n.length+l.length<12){let e=4;n.length+l.length>8&&(e=12-(n.length+l.length));for(let n=a.length-e;n<a.length;n++){let e=a[n];c.push(...t.filter((([t,a])=>a===e)).map((([e,t])=>e)))}c=c.slice(0,e)}return{mostAvailableMaterials:n,secondMostAvailableMaterials:l,leastAvailableMaterials:c}}function selectProductForLevel(e,t,a,n,l){let c=null,r=-1/0;return e.forEach((e=>{let o=getMaterialScore(e,t,a,n);canProductBeProduced(e,l)&&o>r&&(c=e,r=o,Object.entries(e.materials).forEach((([e,t])=>{void 0!==l[e]&&(l[e]-=t)})))})),c}function getMaterialScore(e,t,a,n){let l=0;return Object.entries(e.materials).forEach((([e,c])=>{let r=e.toLowerCase().replace(/ /g,"-");t.includes(r)&&(l+=10),a.includes(r)&&(l+=5),n.includes(r)&&(l-=10)})),l}function canProductBeProduced(e,t){return Object.entries(e.materials).every((([e,a])=>{const n=e.toLowerCase().replace(/ /g,"-");return t[n]&&t[n]>=a}))}function listSelectedProducts(e){Object.entries(e).forEach((([e,t])=>{t.forEach((t=>{const a=document.querySelector(`#level-${e}-items input[name="${t}"]`);a&&(a.value=(parseInt(a.value)||0)+1)}))}))}function inputActive(){document.querySelector(".material-choices").addEventListener("click",(e=>{document.querySelectorAll(".material-choices .my-material").forEach((e=>{""===e.querySelector(".numeric-input").value&&e.classList.remove("active")}));const t=e.target.closest(".my-material");t&&(t.classList.add("active"),t.querySelector(".numeric-input").focus())})),document.querySelectorAll(".material-choices .my-material .numeric-input").forEach((e=>{e.addEventListener("focusout",(()=>{""===e.value&&e.closest(".my-material").classList.remove("active")})),e.addEventListener("focus",(()=>{document.querySelectorAll(".material-choices .my-material").forEach((e=>{""===e.querySelector(".numeric-input").value&&e.classList.remove("active")})),e.closest(".my-material").classList.add("active")}))}));const e=document.querySelector("#templateAmount"),t=document.querySelector(".templateAmountWrap");e.addEventListener("focus",(()=>{t.classList.add("active")})),e.addEventListener("blur",(()=>{e.value||t.classList.remove("active")}))}document.addEventListener("DOMContentLoaded",(function(){createLevelStructure(),addCalculateButton(),generateMaterialList(),formatedInputNumber(),inputActive()})),document.getElementById("calculateWithPreferences").addEventListener("click",(function(){const e=[...document.querySelectorAll('.my-material input[type="text"]'),...document.querySelectorAll("#templateAmount")];let t=!0;e.forEach((e=>{e.value&&0!==parseInt(e.value.replace(/,/g,""))||(t=!1,e.classList.add("missing-input"),setTimeout((()=>{e.classList.remove("missing-input")}),3e3))})),t&&(document.querySelector(".spinner-wrap").classList.add("active"),setTimeout((()=>{let e=gatherMaterialsFromInputs();0===Object.keys(initialMaterials).length&&(initialMaterials={...e});let t=parseInt(document.getElementById("templateAmount").value.replace(/,/g,""));if(isNaN(t))return;isDebugMode||gtag("event","total templates material",{event_templates:t,value:1});let a=Object.values(e).map((e=>"string"==typeof e&&e.includes(",")?parseInt(e.replace(/,/g,""),10):parseInt(e,10)));if(!isDebugMode){let t=a.reduce(((e,t)=>e+t),0),n=a.length>0?t/a.length:0,l=Math.max(...a),c=a.findIndex((e=>e===l)),r=Object.keys(e)[c];gtag("event","material analysis",{average_material_amount:parseInt(n),max_material_amount:l,max_material_name:r,value:1})}let n=calculateProductionPlan(e,t);document.querySelectorAll('#manualInput input[type="number"]').forEach((e=>{e.value=""})),listSelectedProducts(n);const l=document.querySelector(".calculate-button");l&&l.click()}),0))}));
